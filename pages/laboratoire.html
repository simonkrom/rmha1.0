<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratoire de Proximité - Conciergerie Médicale</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563EB;
            --primary-dark: #1D4ED8;
            --secondary: #10B981;
            --accent: #F59E0B;
            --light: #F9FAFB;
            --dark: #1F2937;
            --gray: #6B7280;
            --light-gray: #E5E7EB;
            --white: #FFFFFF;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            color: var(--dark);
            background: url('../assets/images/background.png') center/cover fixed no-repeat, var(--white);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            background-color: var(--white);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .logo-icon {
            color: var(--primary);
            font-size: 2rem;
        }

        .logo-img {
            height: 48px;
            width: auto;
            display: block;
        }

        @media (max-width: 600px) {
            .logo-img {
                height: 40px;
            }
        }

        .logo-text {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary);
        }

        .logo-text span {
            color: var(--secondary);
        }

        .nav-icons {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .nav-icons a {
            color: var(--dark);
            font-size: 1.2rem;
            text-decoration: none;
        }

        /* Patient Info Banner */
        .patient-banner {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--white);
            padding: 20px;
            border-radius: var(--radius);
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .patient-info h2 {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        .patient-info p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .patient-actions {
            display: flex;
            gap: 10px;
        }

        .edit-btn {
            background: rgba(255, 255, 255, 0.2);
            color: var(--white);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 15px;
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Main Content Layout */
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            padding-bottom: 50px;
        }

        @media (min-width: 1024px) {
            .main-content {
                grid-template-columns: 2fr 1fr;
            }
        }

        /* Search Section */
        .search-section {
            margin-bottom: 20px;
        }

        .search-box {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: 2px solid var(--light-gray);
            border-radius: var(--radius);
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 1.2rem;
        }

        /* Exams List */
        .exams-section {
            background-color: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .section-header {
            background-color: var(--light);
            padding: 20px;
            border-bottom: 1px solid var(--light-gray);
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .exams-table {
            width: 100%;
            border-collapse: collapse;
        }

        .exams-table thead {
            background-color: var(--light);
        }

        .exams-table th {
            padding: 15px 20px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid var(--light-gray);
        }

        .exams-table tbody tr {
            border-bottom: 1px solid var(--light-gray);
            transition: background-color 0.3s;
        }

        .exams-table tbody tr:hover {
            background-color: var(--light);
        }

        .exams-table td {
            padding: 15px 20px;
            vertical-align: middle;
        }

        .exam-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .exam-name {
            font-weight: 500;
            color: var(--dark);
        }

        .exam-category {
            font-size: 0.85rem;
            color: var(--gray);
            margin-top: 5px;
        }

        .exam-price {
            font-weight: 600;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .exam-price::after {
            content: " CFA";
            font-size: 0.9rem;
        }

        /* Order Summary */
        .summary-section {
            background-color: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 25px;
            position: sticky;
            top: 100px;
        }

        .summary-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-items {
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--light-gray);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .item-name {
            flex: 1;
            font-size: 0.95rem;
        }

        .item-price {
            font-weight: 600;
            color: var(--primary);
        }

        .item-remove {
            background: none;
            border: none;
            color: #EF4444;
            cursor: pointer;
            margin-left: 10px;
            font-size: 1.2rem;
            padding: 5px;
        }

        .summary-total {
            background-color: var(--light);
            padding: 20px;
            border-radius: var(--radius);
            margin-top: 20px;
        }

        .total-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .total-label {
            color: var(--gray);
        }

        .total-value {
            font-weight: 600;
        }

        .service-fee {
            color: var(--accent);
        }

        .grand-total {
            border-top: 2px solid var(--light-gray);
            padding-top: 15px;
            margin-top: 15px;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .next-button {
            width: 100%;
            padding: 15px;
            background-color: var(--primary);
            color: var(--white);
            border: none;
            border-radius: var(--radius);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .next-button:hover {
            background-color: var(--primary-dark);
        }

        .next-button:disabled {
            background-color: var(--gray);
            cursor: not-allowed;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: var(--white);
            border-radius: var(--radius);
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray);
            cursor: pointer;
            padding: 5px;
        }

        /* Insurance Selection Modal */
        .insurance-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .insurance-option {
            padding: 15px;
            border: 2px solid var(--light-gray);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .insurance-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .insurance-option.selected {
            border-color: var(--primary);
            background-color: rgba(37, 99, 235, 0.05);
        }

        .insurance-logo {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .insurance-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .sub-options {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--light-gray);
        }

        .sub-options.active {
            display: block;
        }

        .sub-option {
            padding: 10px;
            margin-bottom: 5px;
            border: 1px solid var(--light-gray);
            border-radius: var(--radius);
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .sub-option:hover {
            background-color: var(--light);
        }

        .sub-option.selected {
            background-color: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        /* Final Calculation */
        .calculation-section {
            background-color: var(--light);
            padding: 20px;
            border-radius: var(--radius);
            margin: 20px 0;
        }

        .calculation-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .remaining-amount {
            background-color: #FEF3C7;
            border: 2px solid #F59E0B;
            padding: 15px;
            border-radius: var(--radius);
            margin: 15px 0;
            font-weight: 700;
            text-align: center;
            color: var(--dark);
        }

        /* Scanner Section */
        .scanner-section {
            text-align: center;
            margin: 20px 0;
        }

        .scanner-placeholder {
            width: 100%;
            height: 200px;
            background-color: var(--light);
            border: 2px dashed var(--gray);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            cursor: pointer;
        }

        .scanner-placeholder:hover {
            background-color: #F0F9FF;
            border-color: var(--primary);
        }

        .scanner-icon {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .uploaded-file {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--light);
            padding: 15px;
            border-radius: var(--radius);
            margin: 15px 0;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .remove-file {
            background: none;
            border: none;
            color: #EF4444;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* Payment Section */
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .payment-method {
            padding: 15px;
            border: 2px solid var(--light-gray);
            border-radius: var(--radius);
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .payment-method:hover {
            border-color: var(--primary);
        }

        .payment-method.selected {
            border-color: var(--primary);
            background-color: rgba(37, 99, 235, 0.05);
        }

        .payment-icon {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        /* Invoice Section */
        .invoice-section {
            background-color: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 30px;
        }

        .invoice-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .invoice-title {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .invoice-success {
            color: var(--secondary);
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        .invoice-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        @media (min-width: 768px) {
            .invoice-grid {
                grid-template-columns: 2fr 1fr;
            }
        }

        .invoice-details {
            background-color: var(--light);
            padding: 25px;
            border-radius: var(--radius);
        }

        .invoice-patient {
            margin-bottom: 25px;
        }

        .invoice-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--light-gray);
        }

        .invoice-total {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid var(--light-gray);
        }

        .remaining-highlight {
            background-color: #FEF3C7;
            padding: 10px;
            border-radius: var(--radius);
            margin: 10px 0;
            font-weight: 700;
            border: 2px solid #F59E0B;
        }

        .qr-section {
            text-align: center;
            padding: 20px;
            background-color: var(--light);
            border-radius: var(--radius);
        }

        .qr-code {
            width: 200px;
            height: 200px;
            background-color: #333;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 600;
            border-radius: 10px;
        }

        .timer {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin: 15px 0;
        }

        .order-status {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent);
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Step Navigation */
        .step-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--light-gray);
        }

        .step-button {
            padding: 10px 25px;
            background-color: var(--light-gray);
            color: var(--dark);
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .step-button.primary {
            background-color: var(--primary);
            color: var(--white);
        }

        /* Progress Bar */
        .progress-bar {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin: 30px 0;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--light-gray);
            z-index: 1;
            transform: translateY(-50%);
        }

        .progress-step {
            position: relative;
            z-index: 2;
            background-color: var(--white);
            padding: 0 10px;
            text-align: center;
        }

        .step-circle {
            width: 30px;
            height: 30px;
            background-color: var(--light-gray);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .progress-step.active .step-circle {
            background-color: var(--primary);
            color: var(--white);
        }

        .progress-step.completed .step-circle {
            background-color: var(--secondary);
            color: var(--white);
        }

        .step-label {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .progress-step.active .step-label {
            color: var(--primary);
            font-weight: 600;
        }

        /* Utility Classes */
        .hidden {
            display: none;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">
                    <img src="../assets/images/Havre_Anine.png" alt="Le Havre d'Anine" class="logo-img">
                    <div class="logo-text">Conciergerie <span>Médicale</span></div>
                </a>
                
                <div class="nav-icons">
                    <a href="index.html" title="Accueil">
                        <i class="fas fa-home"></i>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Patient Info -->
        <div class="patient-banner fade-in" id="patientBanner">
            <div class="patient-info">
                <h2 id="patientName">Chargement...</h2>
                <p id="patientPhone">Téléphone: Chargement...</p>
                <p id="patientLocation">Localisation: Chargement...</p>
            </div>
            <div class="patient-actions">
                <button class="edit-btn" onclick="window.location.href='enregistrement.html'">
                    <i class="fas fa-edit"></i> Modifier
                </button>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar fade-in">
            <div class="progress-step active" data-step="1">
                <div class="step-circle">1</div>
                <div class="step-label">Sélection</div>
            </div>
            <div class="progress-step" data-step="2">
                <div class="step-circle">2</div>
                <div class="step-label">Assurance</div>
            </div>
            <div class="progress-step" data-step="3">
                <div class="step-circle">3</div>
                <div class="step-label">Scanner</div>
            </div>
            <div class="progress-step" data-step="4">
                <div class="step-circle">4</div>
                <div class="step-label">Paiement</div>
            </div>
            <div class="progress-step" data-step="5">
                <div class="step-circle">5</div>
                <div class="step-label">Facture</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Exams Selection Section -->
            <div id="selectionSection" class="fade-in">
                <div class="search-section">
                    <div class="search-box">
                        <input type="text" class="search-input" id="searchInput" placeholder="Rechercher un examen...">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                </div>

                <div class="exams-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-flask"></i>
                            Liste des Examens
                        </h2>
                    </div>
                    <div class="table-container">
                        <table class="exams-table">
                            <thead>
                                <tr>
                                    <th style="width: 50px;"></th>
                                    <th>Nom de l'examen</th>
                                    <th style="width: 150px;">Prix</th>
                                </tr>
                            </thead>
                            <tbody id="examsTableBody">
                                <!-- Exams will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="summary-section fade-in">
                <h2 class="summary-title">
                    <i class="fas fa-shopping-cart"></i>
                    Récapitulatif
                </h2>
                
                <div class="summary-items" id="summaryItems">
                    <div class="empty-summary">
                        <p style="text-align: center; color: var(--gray); padding: 20px;">
                            Aucun examen sélectionné
                        </p>
                    </div>
                </div>
                
                <div class="summary-total">
                    <div class="total-line">
                        <span class="total-label">Sous-total examens:</span>
                        <span class="total-value" id="examsSubtotal">0 CFA</span>
                    </div>
                    <div class="total-line service-fee">
                        <span class="total-label">Frais de service:</span>
                        <span class="total-value">5 000 CFA</span>
                    </div>
                    <div class="total-line grand-total">
                        <span class="total-label">Total à payer:</span>
                        <span class="total-value" id="grandTotal">5 000 CFA</span>
                    </div>
                </div>
                
                <button class="next-button" id="nextButton" disabled onclick="nextStep()">
                    <span>Suivant</span>
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>

            <!-- Step 2: Insurance Selection (Hidden by default) -->
            <div id="insuranceSection" class="hidden">
                <div class="exams-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-shield-alt"></i>
                            Assurance Médicale
                        </h2>
                    </div>
                    <div class="modal-content" style="box-shadow: none; padding: 20px 0;">
                        <div class="calculation-section">
                            <div class="calculation-line">
                                <span>Total examens:</span>
                                <span id="insuranceExamsTotal">0 CFA</span>
                            </div>
                            <div class="calculation-line">
                                <span>Frais de service:</span>
                                <span>5 000 CFA</span>
                            </div>
                            <div class="calculation-line grand-total">
                                <span>Total à payer:</span>
                                <span id="insuranceTotalBefore">5 000 CFA</span>
                            </div>
                        </div>

                        <h3 style="margin: 20px 0 15px;">Mode de paiement :</h3>
                        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="insuranceMode" value="without" checked id="withoutInsurance">
                                <span>Sans assurance</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="insuranceMode" value="with" id="withInsurance">
                                <span>Avec assurance</span>
                            </label>
                        </div>

                        <div id="insuranceSelection" style="display: none;">
                            <h3 style="margin: 20px 0 15px;">Assurances disponibles :</h3>
                            <div class="insurance-options" id="insuranceOptions">
                                <!-- Insurance options will be populated by JavaScript -->
                            </div>

                            <div id="subOptionsContainer" style="display: none;">
                                <h3 style="margin: 20px 0 15px;">Type de couverture :</h3>
                                <div id="subOptions">
                                    <!-- Sub-options will be populated by JavaScript -->
                                </div>
                            </div>

                            <div id="insuranceCalculation" style="display: none; margin-top: 20px;">
                                <div class="calculation-section">
                                    <div class="calculation-line">
                                        <span>Total examens:</span>
                                        <span id="calcExamsTotal">0 CFA</span>
                                    </div>
                                    <div class="calculation-line">
                                        <span>Prise en charge (<span id="coveragePercent">0%</span>):</span>
                                        <span id="coverageAmount">-0 CFA</span>
                                    </div>
                                    <div class="calculation-line">
                                        <span>Reste à charge:</span>
                                        <span id="remainingAmount">0 CFA</span>
                                    </div>
                                    <div class="calculation-line">
                                        <span>Frais de service:</span>
                                        <span>+5 000 CFA</span>
                                    </div>
                                    <div class="remaining-amount" id="remainingHighlight">
                                        Différence restante: 0 CFA
                                    </div>
                                    <div class="calculation-line grand-total">
                                        <span>Total final:</span>
                                        <span id="finalTotal">5 000 CFA</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="step-navigation">
                    <button class="step-button" onclick="prevStep()">
                        <i class="fas fa-arrow-left"></i>
                        Retour
                    </button>
                    <button class="step-button primary" id="insuranceNextButton" onclick="nextStep()">
                        Continuer
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 3: Scanner Section (Hidden by default) -->
            <div id="scannerSection" class="hidden">
                <div class="exams-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-camera"></i>
                            Scanner Documents
                        </h2>
                    </div>
                    <div class="modal-content" style="box-shadow: none; padding: 20px 0;">
                        <!-- Exam Voucher Scanner -->
                        <div class="scanner-section">
                            <h3 style="margin-bottom: 15px;">Bon d'examen médical</h3>
                            <p style="color: var(--gray); margin-bottom: 15px;">
                                Veuillez scanner ou télécharger votre bon d'examen
                            </p>
                            <div class="scanner-placeholder" onclick="document.getElementById('examFileInput').click()">
                                <i class="fas fa-file-medical scanner-icon"></i>
                                <p>Cliquez pour scanner ou télécharger</p>
                                <p style="font-size: 0.9rem; color: var(--gray); margin-top: 5px;">
                                    Formats acceptés: JPG, PNG, PDF
                                </p>
                            </div>
                            <input type="file" id="examFileInput" class="file-input" accept=".jpg,.jpeg,.png,.pdf">
                            <div id="examFileDisplay" class="hidden">
                                <!-- Exam file will be displayed here -->
                            </div>
                        </div>

                        <!-- Insurance Card Scanner -->
                        <div class="scanner-section" id="insuranceScannerSection">
                            <h3 style="margin-bottom: 15px;">Carte d'assurance</h3>
                            <p style="color: var(--gray); margin-bottom: 15px;">
                                Veuillez scanner ou télécharger votre carte d'assurance
                            </p>
                            <div class="scanner-placeholder" onclick="document.getElementById('insuranceFileInput').click()">
                                <i class="fas fa-id-card scanner-icon"></i>
                                <p>Cliquez pour scanner ou télécharger</p>
                                <p style="font-size: 0.9rem; color: var(--gray); margin-top: 5px;">
                                    Formats acceptés: JPG, PNG, PDF
                                </p>
                            </div>
                            <input type="file" id="insuranceFileInput" class="file-input" accept=".jpg,.jpeg,.png,.pdf">
                            <div id="insuranceFileDisplay" class="hidden">
                                <!-- Insurance file will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="step-navigation">
                    <button class="step-button" onclick="prevStep()">
                        <i class="fas fa-arrow-left"></i>
                        Retour
                    </button>
                    <button class="step-button primary" id="scannerNextButton" onclick="nextStep()" disabled>
                        Continuer
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 4: Payment Section (Hidden by default) -->
            <div id="paymentSection" class="hidden">
                <div class="exams-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-credit-card"></i>
                            Paiement Mobile Money
                        </h2>
                    </div>
                    <div class="modal-content" style="box-shadow: none; padding: 20px 0;">
                        <div class="calculation-section" style="margin-bottom: 30px;">
                            <div class="calculation-line grand-total">
                                <span>Montant à payer:</span>
                                <span id="paymentAmount">5 000 CFA</span>
                            </div>
                        </div>

                        <h3 style="margin-bottom: 15px;">Opérateur Mobile Money :</h3>
                        <div class="payment-methods">
                            <div class="payment-method" data-provider="airtel">
                                <i class="fas fa-mobile-alt payment-icon"></i>
                                <div class="payment-name">Airtel Money</div>
                            </div>
                            <div class="payment-method" data-provider="moov">
                                <i class="fas fa-mobile-alt payment-icon"></i>
                                <div class="payment-name">Moov Money</div>
                            </div>
                            <div class="payment-method" data-provider="libreville">
                                <i class="fas fa-mobile-alt payment-icon"></i>
                                <div class="payment-name">Libreville Money</div>
                            </div>
                        </div>

                        <div id="paymentForm" style="margin-top: 30px; display: none;">
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                                    Numéro de téléphone
                                </label>
                                <div style="display: flex; gap: 10px;">
                                    <div style="flex: 0 0 100px; padding: 12px 15px; border: 2px solid var(--light-gray); border-radius: var(--radius); background-color: var(--light); font-weight: 500; display: flex; align-items: center; gap: 5px;">
                                        <i class="fas fa-flag"></i>
                                        +241
                                    </div>
                                    <input type="tel" id="paymentPhone" style="flex: 1; padding: 12px 15px; border: 2px solid var(--light-gray); border-radius: var(--radius); font-size: 1rem;" placeholder="01 23 45 67" pattern="[0-9]{2} [0-9]{2} [0-9]{2} [0-9]{2}">
                                </div>
                            </div>

                            <div class="form-group" style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                                    Code PIN Mobile Money
                                </label>
                                <input type="password" id="paymentPin" style="width: 100%; padding: 12px 15px; border: 2px solid var(--light-gray); border-radius: var(--radius); font-size: 1rem;" placeholder="••••" maxlength="4">
                            </div>

                            <div style="background-color: #F0F9FF; padding: 15px; border-radius: var(--radius); margin: 20px 0; border-left: 4px solid var(--primary);">
                                <p style="margin: 0; color: var(--dark);">
                                    <i class="fas fa-info-circle" style="color: var(--primary); margin-right: 8px;"></i>
                                    Après validation, vous serez redirigé vers l'interface de paiement de votre opérateur
                                </p>
                            </div>

                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                                <input type="checkbox" id="authorizePayment" style="width: 20px; height: 20px;">
                                <label for="authorizePayment" style="cursor: pointer;">
                                    J'autorise le prélèvement de <span id="authorizeAmount">5 000 CFA</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="step-navigation">
                    <button class="step-button" onclick="prevStep()">
                        <i class="fas fa-arrow-left"></i>
                        Retour
                    </button>
                    <button class="step-button primary" id="paymentButton" onclick="processPayment()" disabled>
                        Valider le paiement
                    </button>
                </div>
            </div>

            <!-- Step 5: Invoice Section (Hidden by default) -->
            <div id="invoiceSection" class="hidden">
                <div class="invoice-section fade-in">
                    <div class="invoice-header">
                        <h1 class="invoice-title">Facture</h1>
                        <div class="invoice-success">
                            <i class="fas fa-check-circle" style="color: var(--secondary); margin-right: 8px;"></i>
                            Paiement confirmé
                        </div>
                        <p style="color: var(--gray);">
                            Référence: <strong id="invoiceReference">CM-2024-001234</strong> | 
                            Date: <strong id="invoiceDate">15/11/2024 14:30</strong>
                        </p>
                    </div>

                    <div class="invoice-grid">
                        <div class="invoice-details">
                            <div class="invoice-patient" id="invoicePatientInfo">
                                <!-- Patient info will be populated by JavaScript -->
                            </div>

                            <h3 style="margin-bottom: 15px;">Examens demandés :</h3>
                            <div id="invoiceExamsList">
                                <!-- Exams list will be populated by JavaScript -->
                            </div>

                            <div style="margin-top: 25px;">
                                <div class="invoice-item">
                                    <span>Total examens:</span>
                                    <span id="invoiceExamsTotal">0 CFA</span>
                                </div>
                                <div class="invoice-item">
                                    <span>Prise en charge assurance:</span>
                                    <span id="invoiceCoverage">-0 CFA</span>
                                </div>
                                <div class="remaining-highlight" id="invoiceRemaining">
                                    Différence restante: 0 CFA
                                </div>
                                <div class="invoice-item">
                                    <span>Frais de service:</span>
                                    <span>5 000 CFA</span>
                                </div>
                                <div class="invoice-total">
                                    <span>TOTAL PAYÉ:</span>
                                    <span id="invoiceTotalPaid">5 000 CFA</span>
                                </div>
                            </div>
                        </div>

                        <div class="qr-section">
                            <div class="qr-code" id="qrCode">
                                <!-- QR Code will be generated here -->
                                QR CODE
                            </div>
                            <div class="timer" id="countdownTimer">02:00:00</div>
                            <div class="order-status" id="orderStatus">COMMANDE EN COURS</div>
                            <p style="margin-top: 15px; color: var(--gray);">
                                Votre coursier arrivera dans les 2 heures
                            </p>
                            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                                <button class="step-button" onclick="trackOrder()">
                                    <i class="fas fa-map-marker-alt"></i>
                                    Suivre ma commande
                                </button>
                                <button class="step-button primary" onclick="downloadInvoice()">
                                    <i class="fas fa-download"></i>
                                    Télécharger
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal" id="loadingModal">
        <div class="modal-content">
            <div style="text-align: center;">
                <div class="spinner" style="margin: 0 auto 20px; width: 50px; height: 50px; border-width: 5px;"></div>
                <h2 class="modal-title">Traitement en cours</h2>
                <p class="modal-message" id="loadingMessage">Veuillez patienter...</p>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal" id="successModal">
        <div class="modal-content">
            <div style="text-align: center;">
                <i class="fas fa-check-circle modal-icon" style="color: var(--secondary); font-size: 4rem; margin-bottom: 20px;"></i>
                <h2 class="modal-title">Paiement Réussi !</h2>
                <p class="modal-message">Votre paiement a été traité avec succès. Génération de votre facture...</p>
            </div>
        </div>
    </div>

    <script>
        // Database of exams with prices
        const examsDatabase = [
            { id: 1, name: "NFS (Numération Formule Sanguine)", category: "Hématologie", price: 15000 },
            { id: 2, name: "Glycémie à jeun", category: "Biochimie", price: 5000 },
            { id: 3, name: "Créatininémie", category: "Biochimie", price: 8000 },
            { id: 4, name: "Bilan Hépatique complet", category: "Biochimie", price: 25000 },
            { id: 5, name: "CRP (Protéine C Réactive)", category: "Inflammation", price: 12000 },
            { id: 6, name: "ECBU (Examen Cytobactériologique des Urines)", category: "Bactériologie", price: 10000 },
            { id: 7, name: "Sérologie VIH", category: "Sérologie", price: 20000 },
            { id: 8, name: "Frottis cervical", category: "Cytologie", price: 18000 },
            { id: 9, name: "Groupage sanguin", category: "Hématologie", price: 7000 },
            { id: 10, name: "TSH (Thyroïde)", category: "Hormonologie", price: 15000 },
            { id: 11, name: "Bilan lipidique", category: "Biochimie", price: 18000 },
            { id: 12, name: "Frottis vaginal", category: "Bactériologie", price: 12000 },
            { id: 13, name: "Électrophorèse de l'hémoglobine", category: "Hématologie", price: 25000 },
            { id: 14, name: "VDRL (Syphilis)", category: "Sérologie", price: 15000 },
            { id: 15, name: "Hépatite B (Ag HBs)", category: "Sérologie", price: 15000 },
            { id: 16, name: "Hépatite C", category: "Sérologie", price: 18000 },
            { id: 17, name: "Examen parasitologique des selles", category: "Parasitologie", price: 8000 },
            { id: 18, name: "Coproculture", category: "Bactériologie", price: 15000 },
            { id: 19, name: "Uricémie", category: "Biochimie", price: 7000 },
            { id: 20, name: "Calcium sérique", category: "Biochimie", price: 7000 }
        ];

        // Database of insurance companies with coverages
        const insuranceDatabase = {
            "CNAMGS": [
                { name: "GEF", coverage: 80 },
                { name: "Secteur Privé", coverage: 70 },
                { name: "Secteur Public", coverage: 60 }
            ],
            "ASCOMA": [
                { name: "Couverture 100%", coverage: 100 },
                { name: "Couverture 80%", coverage: 80 },
                { name: "Couverture 60%", coverage: 60 }
            ],
            "AGF": [
                { name: "Formule Premium", coverage: 90 },
                { name: "Formule Standard", coverage: 75 },
                { name: "Formule Basique", coverage: 60 }
            ],
            "SUNASS": [
                { name: "Gold", coverage: 100 },
                { name: "Silver", coverage: 80 },
                { name: "Bronze", coverage: 65 }
            ],
            "GABON ASSURANCES": [
                { name: "Complet", coverage: 85 },
                { name: "Partiel", coverage: 70 }
            ],
            "NSIA": [
                { name: "Premium", coverage: 95 },
                { name: "Classic", coverage: 80 },
                { name: "Essentiel", coverage: 65 }
            ]
        };

        // Global variables
        let selectedExams = [];
        let selectedInsurance = null;
        let selectedCoverage = null;
        let currentStep = 1;
        let patientData = null;
        let orderData = {
            orderId: null,
            examsSubtotal: 0,
            insuranceCoverage: 0,
            remainingAmount: 0,
            serviceFee: 5000,
            totalAmount: 5000,
            paymentProvider: null,
            paymentPhone: null,
            scannedExamFile: null,
            scannedInsuranceFile: null
        };

        // DOM elements
        const examsTableBody = document.getElementById('examsTableBody');
        const summaryItems = document.getElementById('summaryItems');
        const examsSubtotalEl = document.getElementById('examsSubtotal');
        const grandTotalEl = document.getElementById('grandTotal');
        const nextButton = document.getElementById('nextButton');
        const searchInput = document.getElementById('searchInput');
        const patientBanner = document.getElementById('patientBanner');
        const patientName = document.getElementById('patientName');
        const patientPhone = document.getElementById('patientPhone');
        const patientLocation = document.getElementById('patientLocation');

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            loadPatientData();
            populateExamsTable();
            initializeInsuranceOptions();
            setupEventListeners();
            updateProgressBar();
        });

        // Load patient data from session storage
        function loadPatientData() {
            const savedPatient = sessionStorage.getItem('currentPatient');
            if (savedPatient) {
                patientData = JSON.parse(savedPatient);
                displayPatientInfo();
            } else {
                // Redirect to registration if no patient data
                setTimeout(() => {
                    showToast("Aucune donnée patient trouvée. Veuillez vous enregistrer d'abord.", 'warning');
                    window.location.href = 'enregistrement.html';
                }, 500);
            }
        }

        // Display patient information
        function displayPatientInfo() {
            if (patientData) {
                patientName.textContent = `${patientData.firstName} ${patientData.lastName}`;
                patientPhone.textContent = `Téléphone: ${patientData.phone}`;
                patientLocation.textContent = `Localisation: ${patientData.city}, ${patientData.address}`;
            }
        }

        // Populate exams table
        function populateExamsTable(filter = '') {
            examsTableBody.innerHTML = '';
            
            const filteredExams = examsDatabase.filter(exam => 
                exam.name.toLowerCase().includes(filter.toLowerCase()) ||
                exam.category.toLowerCase().includes(filter.toLowerCase())
            );
            
            filteredExams.forEach(exam => {
                const isSelected = selectedExams.some(selected => selected.id === exam.id);
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="exam-checkbox" 
                               data-id="${exam.id}" 
                               data-name="${exam.name}" 
                               data-price="${exam.price}"
                               ${isSelected ? 'checked' : ''}>
                    </td>
                    <td>
                        <div class="exam-name">${exam.name}</div>
                        <div class="exam-category">${exam.category}</div>
                    </td>
                    <td>
                        <div class="exam-price">${exam.price.toLocaleString('fr-FR')}</div>
                    </td>
                `;
                
                examsTableBody.appendChild(row);
            });
            
            // Add event listeners to checkboxes
            document.querySelectorAll('.exam-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const examId = parseInt(this.dataset.id);
                    const examName = this.dataset.name;
                    const examPrice = parseInt(this.dataset.price);
                    
                    if (this.checked) {
                        selectedExams.push({ id: examId, name: examName, price: examPrice });
                    } else {
                        selectedExams = selectedExams.filter(exam => exam.id !== examId);
                    }
                    
                    updateOrderSummary();
                });
            });
        }

        // Update order summary
        function updateOrderSummary() {
            const examsTotal = selectedExams.reduce((sum, exam) => sum + exam.price, 0);
            const total = examsTotal + orderData.serviceFee;
            
            // Update totals
            orderData.examsSubtotal = examsTotal;
            orderData.totalAmount = total;
            
            examsSubtotalEl.textContent = `${examsTotal.toLocaleString('fr-FR')} CFA`;
            grandTotalEl.textContent = `${total.toLocaleString('fr-FR')} CFA`;
            
            // Update summary items
            if (selectedExams.length > 0) {
                summaryItems.innerHTML = '';
                selectedExams.forEach((exam, index) => {
                    const item = document.createElement('div');
                    item.className = 'summary-item';
                    item.innerHTML = `
                        <span class="item-name">${exam.name}</span>
                        <span class="item-price">${exam.price.toLocaleString('fr-FR')} CFA</span>
                        <button class="item-remove" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    summaryItems.appendChild(item);
                });
                
                // Add remove functionality
                document.querySelectorAll('.item-remove').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        selectedExams.splice(index, 1);
                        updateOrderSummary();
                        // Uncheck corresponding checkbox
                        const examId = selectedExams[index]?.id;
                        if (examId) {
                            const checkbox = document.querySelector(`.exam-checkbox[data-id="${examId}"]`);
                            if (checkbox) checkbox.checked = false;
                        }
                        populateExamsTable(searchInput.value);
                    });
                });
            } else {
                summaryItems.innerHTML = `
                    <div class="empty-summary">
                        <p style="text-align: center; color: var(--gray); padding: 20px;">
                            Aucun examen sélectionné
                        </p>
                    </div>
                `;
            }
            
            // Enable/disable next button
            nextButton.disabled = selectedExams.length === 0;
        }

        // Initialize insurance options
        function initializeInsuranceOptions() {
            const insuranceOptions = document.getElementById('insuranceOptions');
            insuranceOptions.innerHTML = '';
            
            Object.keys(insuranceDatabase).forEach(insuranceName => {
                const option = document.createElement('div');
                option.className = 'insurance-option';
                option.dataset.insurance = insuranceName;
                option.innerHTML = `
                    <div class="insurance-logo">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="insurance-name">${insuranceName}</div>
                `;
                
                option.addEventListener('click', function() {
                    selectInsurance(insuranceName);
                });
                
                insuranceOptions.appendChild(option);
            });
        }

        // Select insurance
        function selectInsurance(insuranceName) {
            // Remove selected class from all options
            document.querySelectorAll('.insurance-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            document.querySelector(`.insurance-option[data-insurance="${insuranceName}"]`).classList.add('selected');
            
            selectedInsurance = insuranceName;
            
            // Show sub-options
            const subOptionsContainer = document.getElementById('subOptionsContainer');
            const subOptions = document.getElementById('subOptions');
            
            subOptions.innerHTML = '';
            insuranceDatabase[insuranceName].forEach(coverage => {
                const subOption = document.createElement('div');
                subOption.className = 'sub-option';
                subOption.dataset.coverage = coverage.coverage;
                subOption.textContent = `${coverage.name} ${coverage.coverage}%`;
                
                subOption.addEventListener('click', function() {
                    // Remove selected class from all sub-options
                    document.querySelectorAll('.sub-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked sub-option
                    this.classList.add('selected');
                    
                    selectedCoverage = coverage.coverage;
                    updateInsuranceCalculation();
                });
                
                subOptions.appendChild(subOption);
            });
            
            subOptionsContainer.style.display = 'block';
            document.getElementById('insuranceCalculation').style.display = 'block';
            
            // Auto-select first coverage option
            if (insuranceDatabase[insuranceName].length > 0) {
                const firstOption = subOptions.querySelector('.sub-option');
                firstOption.click();
            }
        }

        // Update insurance calculation
        function updateInsuranceCalculation() {
            if (!selectedInsurance || !selectedCoverage) return;
            
            const examsTotal = orderData.examsSubtotal;
            const coverageAmount = Math.round(examsTotal * (selectedCoverage / 100));
            const remaining = examsTotal - coverageAmount;
            const finalTotal = remaining + orderData.serviceFee;
            
            // Update display
            document.getElementById('calcExamsTotal').textContent = `${examsTotal.toLocaleString('fr-FR')} CFA`;
            document.getElementById('coveragePercent').textContent = selectedCoverage;
            document.getElementById('coverageAmount').textContent = `-${coverageAmount.toLocaleString('fr-FR')} CFA`;
            document.getElementById('remainingAmount').textContent = `${remaining.toLocaleString('fr-FR')} CFA`;
            document.getElementById('finalTotal').textContent = `${finalTotal.toLocaleString('fr-FR')} CFA`;
            
            // Update remaining highlight
            const remainingHighlight = document.getElementById('remainingHighlight');
            remainingHighlight.textContent = `Différence restante: ${remaining.toLocaleString('fr-FR')} CFA`;
            
            // Update order data
            orderData.insuranceCoverage = coverageAmount;
            orderData.remainingAmount = remaining;
            orderData.totalAmount = finalTotal;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search functionality
            searchInput.addEventListener('input', function() {
                populateExamsTable(this.value);
            });
            
            // Insurance mode toggle
            document.querySelectorAll('input[name="insuranceMode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const insuranceSelection = document.getElementById('insuranceSelection');
                    const insuranceScanner = document.getElementById('insuranceScannerSection');
                    
                    if (this.value === 'with') {
                        insuranceSelection.style.display = 'block';
                        insuranceScanner.style.display = 'block';
                    } else {
                        insuranceSelection.style.display = 'none';
                        insuranceScanner.style.display = 'none';
                        selectedInsurance = null;
                        selectedCoverage = null;
                        
                        // Reset insurance calculation
                        orderData.insuranceCoverage = 0;
                        orderData.remainingAmount = orderData.examsSubtotal;
                        orderData.totalAmount = orderData.examsSubtotal + orderData.serviceFee;
                    }
                });
            });
            
            // File upload for exam voucher
            document.getElementById('examFileInput').addEventListener('change', function(e) {
                handleFileUpload(e, 'examFileDisplay', 'exam');
            });
            
            // File upload for insurance card
            document.getElementById('insuranceFileInput').addEventListener('change', function(e) {
                handleFileUpload(e, 'insuranceFileDisplay', 'insurance');
            });
            
            // Payment method selection
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', function() {
                    // Remove selected class from all methods
                    document.querySelectorAll('.payment-method').forEach(m => {
                        m.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked method
                    this.classList.add('selected');
                    
                    orderData.paymentProvider = this.dataset.provider;
                    document.getElementById('paymentForm').style.display = 'block';
                    validatePaymentForm();
                });
            });
            
            // Payment form validation
            document.getElementById('paymentPhone').addEventListener('input', function(e) {
                // Format phone number
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 8) value = value.substring(0, 8);
                
                let formatted = '';
                for (let i = 0; i < value.length; i++) {
                    if (i === 2 || i === 4 || i === 6) {
                        formatted += ' ';
                    }
                    formatted += value[i];
                }
                
                e.target.value = formatted;
                validatePaymentForm();
            });
            
            document.getElementById('paymentPin').addEventListener('input', validatePaymentForm);
            document.getElementById('authorizePayment').addEventListener('change', validatePaymentForm);
            
            // Update authorize amount
            const authorizeAmount = document.getElementById('authorizeAmount');
            authorizeAmount.textContent = `${orderData.totalAmount.toLocaleString('fr-FR')} CFA`;
            document.getElementById('paymentAmount').textContent = `${orderData.totalAmount.toLocaleString('fr-FR')} CFA`;
        }

        // Handle file upload
        function handleFileUpload(event, displayId, type) {
            const file = event.target.files[0];
            if (!file) return;
            
            const display = document.getElementById(displayId);
            display.className = 'uploaded-file';
            display.innerHTML = `
                <div class="file-info">
                    <i class="fas fa-file" style="color: var(--primary); font-size: 1.5rem;"></i>
                    <div>
                        <div style="font-weight: 500;">${file.name}</div>
                        <div style="font-size: 0.9rem; color: var(--gray);">
                            ${(file.size / 1024).toFixed(2)} KB
                        </div>
                    </div>
                </div>
                <button class="remove-file" onclick="removeFile('${type}')">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            
            if (type === 'exam') {
                orderData.scannedExamFile = file;
            } else {
                orderData.scannedInsuranceFile = file;
            }
            
            validateScannerStep();
        }

        // Remove uploaded file
        function removeFile(type) {
            if (type === 'exam') {
                document.getElementById('examFileDisplay').className = 'hidden';
                document.getElementById('examFileInput').value = '';
                orderData.scannedExamFile = null;
            } else {
                document.getElementById('insuranceFileDisplay').className = 'hidden';
                document.getElementById('insuranceFileInput').value = '';
                orderData.scannedInsuranceFile = null;
            }
            
            validateScannerStep();
        }

        // Validate scanner step
        function validateScannerStep() {
            const scannerNextButton = document.getElementById('scannerNextButton');
            const withInsurance = document.getElementById('withInsurance').checked;
            
            let isValid = orderData.scannedExamFile !== null;
            
            if (withInsurance) {
                isValid = isValid && orderData.scannedInsuranceFile !== null;
            }
            
            scannerNextButton.disabled = !isValid;
        }

        // Validate payment form
        function validatePaymentForm() {
            const paymentButton = document.getElementById('paymentButton');
            const phone = document.getElementById('paymentPhone').value;
            const pin = document.getElementById('paymentPin').value;
            const authorized = document.getElementById('authorizePayment').checked;
            
            const phonePattern = /^\d{2} \d{2} \d{2} \d{2}$/;
            const isValid = orderData.paymentProvider !== null &&
                          phonePattern.test(phone) &&
                          pin.length === 4 &&
                          authorized;
            
            paymentButton.disabled = !isValid;
        }

        // Step navigation
        function nextStep() {
            if (currentStep < 5) {
                currentStep++;
                showStep(currentStep);
                updateProgressBar();
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
                updateProgressBar();
            }
        }

        // Show specific step
        function showStep(step) {
            // Hide all steps
            document.getElementById('selectionSection').classList.add('hidden');
            document.getElementById('insuranceSection').classList.add('hidden');
            document.getElementById('scannerSection').classList.add('hidden');
            document.getElementById('paymentSection').classList.add('hidden');
            document.getElementById('invoiceSection').classList.add('hidden');
            
            // Show current step
            switch(step) {
                case 1:
                    document.getElementById('selectionSection').classList.remove('hidden');
                    break;
                case 2:
                    document.getElementById('insuranceSection').classList.remove('hidden');
                    updateInsuranceStep();
                    break;
                case 3:
                    document.getElementById('scannerSection').classList.remove('hidden');
                    validateScannerStep();
                    break;
                case 4:
                    document.getElementById('paymentSection').classList.remove('hidden');
                    updatePaymentStep();
                    break;
                case 5:
                    document.getElementById('invoiceSection').classList.remove('hidden');
                    generateInvoice();
                    startCountdown();
                    break;
            }
        }

        // Update insurance step with current totals
        function updateInsuranceStep() {
            document.getElementById('insuranceExamsTotal').textContent = 
                `${orderData.examsSubtotal.toLocaleString('fr-FR')} CFA`;
            document.getElementById('insuranceTotalBefore').textContent = 
                `${(orderData.examsSubtotal + orderData.serviceFee).toLocaleString('fr-FR')} CFA`;
            
            // Reset insurance selection if going back
            if (currentStep === 2) {
                selectedInsurance = null;
                selectedCoverage = null;
                document.getElementById('withoutInsurance').checked = true;
                document.getElementById('insuranceSelection').style.display = 'none';
                document.getElementById('insuranceScannerSection').style.display = 'none';
                document.querySelectorAll('.insurance-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                document.getElementById('subOptionsContainer').style.display = 'none';
                document.getElementById('insuranceCalculation').style.display = 'none';
            }
        }

        // Update payment step with current total
        function updatePaymentStep() {
            document.getElementById('paymentAmount').textContent = 
                `${orderData.totalAmount.toLocaleString('fr-FR')} CFA`;
            document.getElementById('authorizeAmount').textContent = 
                `${orderData.totalAmount.toLocaleString('fr-FR')} CFA`;
        }

        // Update progress bar
        function updateProgressBar() {
            document.querySelectorAll('.progress-step').forEach(step => {
                const stepNum = parseInt(step.dataset.step);
                step.classList.remove('active', 'completed');
                
                if (stepNum < currentStep) {
                    step.classList.add('completed');
                } else if (stepNum === currentStep) {
                    step.classList.add('active');
                }
            });
        }

        // Process payment
        function processPayment() {
            showModal('loadingModal');
            document.getElementById('loadingMessage').textContent = 
                "Connexion à votre opérateur Mobile Money...";
            
            // Simulate payment processing
            setTimeout(() => {
                closeModal('loadingModal');
                showModal('successModal');
                
                // Generate order ID
                orderData.orderId = 'CMD-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
                orderData.paymentPhone = document.getElementById('paymentPhone').value;
                orderData.paymentDate = new Date().toISOString();
                
                // Save order to session storage
                sessionStorage.setItem('currentOrder', JSON.stringify(orderData));

                // Emit order to server so managers / coursiers / pharmaciens are notified
                try {
                    const socket = io();
                    socket.emit('newOrder', Object.assign({}, orderData, { patient: patientData }));
                } catch (e) {
                    console.warn('Socket.IO not available (laboratoire):', e && e.message);
                }
                
                // Move to invoice step after delay
                setTimeout(() => {
                    closeModal('successModal');
                    currentStep = 5;
                    showStep(5);
                    updateProgressBar();
                }, 2000);
            }, 3000);
        }

        // Generate invoice
        function generateInvoice() {
            // Update invoice reference and date
            document.getElementById('invoiceReference').textContent = orderData.orderId;
            const now = new Date();
            document.getElementById('invoiceDate').textContent = 
                `${now.toLocaleDateString('fr-FR')} ${now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}`;
            
            // Update patient info
            const invoicePatientInfo = document.getElementById('invoicePatientInfo');
            invoicePatientInfo.innerHTML = `
                <h3 style="margin-bottom: 10px;">Patient</h3>
                <p><strong>Nom:</strong> ${patientData.firstName} ${patientData.lastName}</p>
                <p><strong>Téléphone:</strong> ${patientData.phone}</p>
                <p><strong>Adresse:</strong> ${patientData.address}, ${patientData.city}</p>
            `;
            
            // Update exams list
            const invoiceExamsList = document.getElementById('invoiceExamsList');
            invoiceExamsList.innerHTML = '';
            selectedExams.forEach(exam => {
                const item = document.createElement('div');
                item.className = 'invoice-item';
                item.innerHTML = `
                    <span>${exam.name}</span>
                    <span>${exam.price.toLocaleString('fr-FR')} CFA</span>
                `;
                invoiceExamsList.appendChild(item);
            });
            
            // Update totals
            document.getElementById('invoiceExamsTotal').textContent = 
                `${orderData.examsSubtotal.toLocaleString('fr-FR')} CFA`;
            document.getElementById('invoiceCoverage').textContent = 
                `-${orderData.insuranceCoverage.toLocaleString('fr-FR')} CFA`;
            document.getElementById('invoiceRemaining').textContent = 
                `Différence restante: ${orderData.remainingAmount.toLocaleString('fr-FR')} CFA`;
            document.getElementById('invoiceTotalPaid').textContent = 
                `${orderData.totalAmount.toLocaleString('fr-FR')} CFA`;
            
            // Generate QR code (simulated)
            const qrCode = document.getElementById('qrCode');
            qrCode.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">📱</div>
                    <div>${orderData.orderId}</div>
                </div>
            `;
        }

        // Start countdown timer
        function startCountdown() {
            let timeLeft = 2 * 60 * 60; // 2 hours in seconds
            const timerElement = document.getElementById('countdownTimer');
            
            function updateTimer() {
                if (timeLeft <= 0) {
                    timerElement.textContent = "00:00:00";
                    document.getElementById('orderStatus').textContent = "TEMPS ÉCOULÉ";
                    return;
                }
                
                const hours = Math.floor(timeLeft / 3600);
                const minutes = Math.floor((timeLeft % 3600) / 60);
                const seconds = timeLeft % 60;
                
                timerElement.textContent = 
                    `${hours.toString().padStart(2, '0')}:` +
                    `${minutes.toString().padStart(2, '0')}:` +
                    `${seconds.toString().padStart(2, '0')}`;
                
                timeLeft--;
                setTimeout(updateTimer, 1000);
            }
            
            updateTimer();
        }

        // Track order function
        function trackOrder() {
                showToast("Fonctionnalité de suivi en cours de développement. Votre commande est en route!", 'info');
        }

        // Download invoice function
        function downloadInvoice() {
            showToast("Téléchargement de la facture...", 'info');
            // In a real implementation, this would generate a PDF
        }

        // Show modal
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // Spinner animation
        const style = document.createElement('style');
        style.textContent = `
            .spinner {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top-color: var(--white);
                animation: spin 1s ease-in-out infinite;
            }
            
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
            
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    </script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="../assets/js/toast.js"></script>
</body>
</html>